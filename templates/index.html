<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Planes</title>
    <link rel="icon" href="{{ url_for('static', path='/penguin_favicon.png') }}" type="image/png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="{{ url_for('static', path='/css/main.css') }}">
</head>

<body>
    <div class="container main-container">
        <header class="main-header">
            <h1>üêß Dos en la ciudad ü¶ñ</h1>
            {% if user_email %}
            <div class="user-info">
                <span>{{ user_email }}</span>
                <button type="button" id="logout-btn" class="logout-btn">Logout</button>
            </div>
            {% endif %}
        </header>

        <section class="top-bar">
            <div class="top-bar-left">
                <button type="button" id="toggle-sidebar-btn" class="secondary-btn" title="Toggle List View">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="global-search" placeholder="Search by name, address or tags...">
                </div>
            </div>
            <div class="top-actions">
                <button type="button" id="toggle-filters-btn" class="secondary-btn">
                    <i class="fas fa-filter"></i> Filters
                </button>
                <button type="button" id="toggle-add-place-form-btn" class="primary-btn">
                    <i class="fas fa-plus"></i> Add Place
                </button>
            </div>
        </section>

        <section id="filter-panel" class="filter-panel" style="display: none;">
            <form id="filter-form" onsubmit="return false;">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label for="category">Category</label>
                        <select id="category" name="category">
                            <option value="">All Categories</option>
                            {% for cat in categories %}
                            <option value="{{ cat }}">{{ cat|capitalize }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="status">Status</label>
                        <select id="status" name="status">
                            <option value="">All Statuses</option>
                            {% for stat_val in statuses %}
                            <option value="{{ stat_val }}">{{ stat_val|replace('_', ' ')|capitalize }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="tag-filter-input">Tags</label>
                        <input id="tag-filter-input" name="tags" placeholder="Filter by tags...">
                    </div>
                </div>
                <div class="filter-actions">
                    <button type="button" id="clear-filters-btn" class="link-btn">Reset Filters</button>
                </div>
            </form>
        </section>

        <main class="main-content-area" id="main-content-area">
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div><span id="places-count">0</span> Places</div>
                    <div class="sort-controls">
                        <select id="sort-places">
                            <option value="newest">Newest</option>
                            <option value="name_asc">A-Z</option>
                            <option value="name_desc">Z-A</option>
                            <option value="rating">Rating</option>
                        </select>
                    </div>
                </div>
                <div class="sidebar-list" id="places-list">
                    <div class="sidebar-loading">Loading places...</div>
                </div>
            </aside>

            <section class="map-view">
                <div id="map"></div>
                <div id="pinning-map-container">
                    <div id="pinning-map"></div>
                    <div id="pinning-map-controls">
                        <button type="button" id="confirm-pin-btn">Confirm Pin Location</button>
                        <button type="button" id="cancel-pin-btn">Cancel Pinning</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Form and Modal Sections -->
        <section id="add-place-wrapper-section" class="form-section overlay-section">
            <form id="add-place-form" action="{{ request.url_for('handle_create_new_place_form') }}" method="post">
                <fieldset>
                    <legend>Add New Place</legend>
                    <label for="name">Place Name:</label>
                    <input type="text" id="name" name="name" required maxlength="100">
                    <label for="address-input">Location:</label>
                    <div class="address-input-row">
                        <input type="text" id="address-input" placeholder="Enter address or place name">
                        <button type="button" id="find-coords-btn">Find</button>
                    </div>
                    <button type="button" id="pin-on-map-btn" class="secondary-btn">Pin on Map</button>
                    <div id="map-pin-instruction" class="map-pin-instruction">Drag the pin on the map to set location.
                    </div>
                    <div id="geocode-status" class="status-message"></div>
                    <div id="coords-section" class="coords-section" style="display:none;">
                        <p><strong>Selected:</strong> <span id="display-address"></span></p>
                        <input type="hidden" id="latitude" name="latitude" required>
                        <input type="hidden" id="longitude" name="longitude" required>
                        <input type="hidden" id="address" name="address">
                        <input type="hidden" id="city" name="city">
                        <input type="hidden" id="country" name="country">
                    </div>
                    <label for="add-category">Category:</label>
                    <select id="add-category" name="category" required>
                        {% for cat in categories %}
                        <option value="{{ cat }}">{{ cat|capitalize }}</option>
                        {% endfor %}
                    </select>
                    <label for="add-status">Status:</label>
                    <select id="add-status" name="status" required>
                        {% for stat_val in statuses %}
                        {% if stat_val != 'visited' and stat_val != 'pending_scheduled' %}
                        <option value="{{ stat_val }}" {% if stat_val=='pending' %}selected{% endif %}>{{
                            stat_val|replace('_', ' ')|capitalize }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                    <div class="form-actions">
                        <button type="submit" id="add-place-submit-btn" disabled>Add Place</button>
                        <button type="button" class="cancel-btn" id="add-place-cancel-btn">Cancel</button>
                    </div>
                </fieldset>
            </form>
        </section>

        <section class="form-section overlay-section" id="edit-place-section">
            <form id="edit-place-form" action="" method="post">
                <fieldset>
                    <h2>Edit Place: <span id="edit-place-form-title"></span></h2>
                    <label for="edit-name">Place Name:</label>
                    <input type="text" id="edit-name" name="name" required maxlength="100">
                    <label for="edit-address-input">Update Location:</label>
                    <div class="address-input-row">
                        <input type="text" id="edit-address-input" placeholder="New address...">
                        <button type="button" id="edit-find-coords-btn">Find</button>
                    </div>
                    <button type="button" id="edit-pin-on-map-btn" class="secondary-btn">Pin New Location</button>
                    <div id="edit-map-pin-instruction" class="map-pin-instruction">Drag the pin to update location.
                    </div>
                    <div id="edit-geocode-status" class="status-message"></div>
                    <div id="edit-coords-section" class="coords-section">
                        <input type="hidden" id="edit-latitude" name="latitude" required>
                        <input type="hidden" id="edit-longitude" name="longitude" required>
                        <input type="hidden" id="edit-address" name="address">
                        <input type="hidden" id="edit-city" name="city">
                        <input type="hidden" id="edit-country" name="country">
                    </div>
                    <label for="edit-category">Category:</label>
                    <select id="edit-category" name="category" required>
                        {% for cat in categories %}
                        <option value="{{ cat }}">{{ cat|capitalize }}</option>
                        {% endfor %}
                    </select>
                    <label for="edit-status">Status:</label>
                    <select id="edit-status" name="status" required>
                        {% for stat_val in statuses %}
                        <option value="{{ stat_val }}">{{ stat_val|replace('_', ' ')|capitalize }}</option>
                        {% endfor %}
                    </select>
                    <label for="edit-tags-input">Tags:</label>
                    <input id="edit-tags-input" name="tags_input" placeholder="Add tags...">
                    <div class="form-actions">
                        <button type="submit" id="edit-place-submit-btn">Save Changes</button>
                        <button type="button" class="cancel-btn">Cancel</button>
                    </div>
                </fieldset>
            </form>
        </section>

        <section class="form-section overlay-section" id="plan-visit-section">
            <form id="plan-visit-form" action="" method="post">
                <fieldset>
                    <h2>Plan Visit: <span id="plan-visit-place-title"></span></h2>
                    <input type="hidden" id="plan-visit-place-id" name="place_id">
                    <input type="hidden" id="plan-visit-id" name="visit_id">
                    <div class="form-row">
                        <div class="filter-group">
                            <label for="visit-date">Date</label>
                            <input type="date" id="visit-date" name="visit_date" required>
                        </div>
                        <div class="filter-group">
                            <label for="visit-time">Time</label>
                            <input type="time" id="visit-time" name="visit_time" required>
                        </div>
                    </div>
                    <div id="plan-visit-status" class="status-message"></div>
                    <div id="plan-visit-calendar-action" style="display:none;">
                        <button type="button" id="plan-visit-add-to-calendar-btn" class="secondary-btn">
                            <i class="fas fa-calendar-plus"></i> Add to Calendar
                        </button>
                    </div>
                    <div class="form-actions">
                        <button type="submit" id="plan-visit-submit-btn">Save Visit</button>
                        <button type="button" class="cancel-btn" id="plan-visit-cancel-btn">Cancel</button>
                    </div>
                </fieldset>
            </form>
        </section>

        <section class="form-section overlay-section" id="visit-review-image-section">
            <form id="visit-review-image-form" action="" method="post" enctype="multipart/form-data">
                <fieldset>
                    <h2>Review: <span id="visit-review-place-title"></span></h2>
                    <p>Visit on <span id="visit-review-datetime-display"></span></p>
                    <input type="hidden" id="visit-review-visit-id" name="visit_id">
                    <label for="visit-review-title">Title</label>
                    <input type="text" id="visit-review-title" name="review_title">
                    <label for="visit-review-text">Comment</label>
                    <textarea id="visit-review-text" name="review_text" rows="3"></textarea>
                    <label>Rating</label>
                    <div class="rating-stars" id="visit-review-rating-stars">
                        {% for i in range(1, 6) %}<span class="star" data-value="{{ i }}"><i
                                class="far fa-star"></i></span>{% endfor %}
                    </div>
                    <input type="hidden" id="visit-review-rating" name="rating">
                    <label for="visit-review-image">Photo</label>
                    <input type="file" id="visit-review-image" name="image" accept="image/*">
                    <div id="current-visit-image-review-section" style="display:none;">
                        <img id="current-visit-image-review-thumb" src="" alt="Thumbnail">
                        <div class="checkbox-group">
                            <input type="checkbox" id="visit-review-remove-image" name="remove_image" value="yes">
                            <label for="visit-review-remove-image">Remove photo</label>
                        </div>
                    </div>
                    <div id="visit-review-status" class="status-message"></div>
                    <div class="form-actions">
                        <button type="submit" id="visit-review-image-submit-btn">Save Review</button>
                        <button type="button" class="cancel-btn">Cancel</button>
                    </div>
                </fieldset>
            </form>
        </section>

        <div id="visits-list-modal" class="modal-section overlay-section">
            <fieldset>
                <h2>Visits: <span id="visits-list-place-title"></span></h2>
                <div class="modal-content" id="visits-list-content"></div>
                <div id="visits-list-status" class="status-message"></div>
                <div class="modal-actions">
                    <button type="button" id="visits-list-plan-new-btn" class="primary-btn">Schedule New Visit</button>
                    <button type="button" class="cancel-btn" id="visits-list-close-btn">Close</button>
                </div>
            </fieldset>
        </div>

        <div id="ics-customize-modal" class="modal-section overlay-section">
            <form id="ics-customize-form">
                <fieldset>
                    <h2>Export Calendar</h2>
                    <input type="hidden" id="ics-visit-id" name="visit_id">
                    <label for="ics-event-name">Event Name</label>
                    <input type="text" id="ics-event-name" name="event_name" required>
                    <div class="form-row">
                        <input type="number" id="ics-duration-value" name="duration_value" value="2" min="1">
                        <select id="ics-duration-unit" name="duration_unit">
                            <option value="hours" selected>Hours</option>
                            <option value="minutes">Minutes</option>
                        </select>
                    </div>
                    <div id="ics-customize-status" class="status-message"></div>
                    <div class="form-actions">
                        <button type="button" id="ics-download-btn">Download .ics</button>
                        <button type="button" id="ics-google-calendar-btn">Google</button>
                        <button type="button" class="cancel-btn">Cancel</button>
                    </div>
                </fieldset>
            </form>
        </div>

        <section class="modal-section overlay-section" id="see-visit-review-section">
            <fieldset>
                <h2>Review for: <span id="see-visit-review-place-title"></span></h2>
                <div class="modal-content">
                    <div id="see-visit-review-rating-display" class="rating-stars-display"></div>
                    <h3 id="see-visit-review-display-title"></h3>
                    <p id="see-visit-review-display-text"></p>
                    <img id="see-visit-review-display-image" src="" alt="Visit image" />
                </div>
                <div class="modal-actions">
                    <button type="button" id="see-visit-review-edit-btn" class="secondary-btn">Edit Review</button>
                    <button type="button" class="cancel-btn">Close</button>
                </div>
            </fieldset>
        </section>
    </div>

    <script id="map-data" type="application/json">{{ map_data_json | safe }}</script>
    <script id="user-tags-data" type="application/json">{{ all_user_tags_json | safe }}</script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
    <script type="module" src="{{ url_for('static', path='/js/main.js') }}"></script>
</body>

</html>